{"version":3,"sources":["../hooks/index.ts","../hooks/getDataFromWallet.ts"],"sourcesContent":["export * from './getDataFromWallet';\n","import { MasterCertificate, Utils } from \"@bsv/sdk\";\r\n\r\nexport type GetDataFromWalletErrors = Record<string, string[]>;\r\n\r\nexport interface GetDataFromWalletResult {\r\n    success: boolean;\r\n    data: ProfileData | null;\r\n    errors?: GetDataFromWalletErrors;\r\n}\r\n\r\nexport interface GetDataFromWalletOptions {\r\n    certifiers?: string[];\r\n    connectionTypes?: string[];\r\n    profileType?: string;\r\n    basket?: string;\r\n}\r\n\r\nexport interface ConnectionData {\r\n    type: string;\r\n    url: string;\r\n    verified: boolean;\r\n}\r\n\r\nexport interface ProfileData {\r\n    displayName: string;\r\n    description: string;\r\n    locationLng: number;\r\n    locationLat: number;\r\n    email: string;\r\n    phoneNumber: string;\r\n    imageKey: string | null; // S3 key from token\r\n    privateFields: string[];\r\n    websites: Array<{ id: string; type: string; url: string; makePublic: boolean }>;\r\n    connections: ConnectionData[];\r\n}\r\n\r\n/**\r\n * Checks if user has a certificate and fetches profile data from wallet\r\n * Returns profile data if certificate exists, null if no certificate\r\n */\r\nexport async function getDataFromWallet(userWallet: any, options?: GetDataFromWalletOptions): Promise<GetDataFromWalletResult> {\r\n    const errors: GetDataFromWalletErrors = {};\r\n    const addError = (key: string, message: string) => {\r\n        (errors[key] ??= []).push(message);\r\n    };\r\n\r\n    return getDataFromWalletWithOptions(userWallet, options, errors, addError);\r\n}\r\n\r\nasync function getDataFromWalletWithOptions(\r\n    userWallet: any,\r\n    options: GetDataFromWalletOptions | undefined,\r\n    errors: GetDataFromWalletErrors,\r\n    addError: (key: string, message: string) => void\r\n): Promise<GetDataFromWalletResult> {\r\n\r\n    if (!userWallet) {\r\n        addError('wallet', 'No wallet available');\r\n        return {\r\n            success: false,\r\n            data: null,\r\n            errors,\r\n        };\r\n    }\r\n\r\n    try {\r\n        const profileType = typeof options?.profileType === 'string' && options.profileType.trim() !== ''\r\n            ? options.profileType : null;\r\n\r\n        if (!profileType) {\r\n            addError('config', 'No profile type provided');\r\n            const maybeErrors = Object.keys(errors).length > 0 ? errors : undefined;\r\n            return {\r\n                success: false,\r\n                data: null,\r\n                errors: maybeErrors,\r\n            };\r\n        }\r\n\r\n        const basket = typeof options?.basket === 'string' && options.basket.trim() !== ''\r\n            ? options.basket\r\n            : null;\r\n\r\n        if (!basket) {\r\n            addError('config', 'No basket provided');\r\n            const maybeErrors = Object.keys(errors).length > 0 ? errors : undefined;\r\n            return {\r\n                success: false,\r\n                data: null,\r\n                errors: maybeErrors,\r\n            };\r\n        }\r\n        \r\n        const profileCertTypeB64 = Utils.toBase64(Utils.toArray(profileType));\r\n\r\n        const extractConnectionTypeName = (certType: string): string => {\r\n            if (certType.includes('LinkedIn')) return 'LinkedIn';\r\n            if (certType.includes('Twitter')) return 'Twitter';\r\n            if (certType.includes('Instagram')) return 'Instagram';\r\n            if (certType.includes('Telegram')) return 'Telegram';\r\n            if (certType.includes('Discord')) return 'Discord';\r\n            return certType; // fallback to original\r\n        };\r\n\r\n        const connectionTypes = (options?.connectionTypes ?? []).filter(\r\n            (type): type is string => typeof type === 'string' && type.trim() !== ''\r\n        );\r\n\r\n        const certifiers = (options?.certifiers ?? []).filter(\r\n            (key): key is string => typeof key === 'string' && key.trim() !== ''\r\n        );\r\n\r\n        if (certifiers.length === 0) {\r\n            addError('config', 'No certifiers provided');\r\n            const maybeErrors = Object.keys(errors).length > 0 ? errors : undefined;\r\n            return {\r\n                success: false,\r\n                data: null,\r\n                errors: maybeErrors,\r\n            };\r\n        }\r\n\r\n        const connectionTypesB64 = connectionTypes.map((connType) => Utils.toBase64(Utils.toArray(connType)));\r\n        const requestedTypesB64 = [profileCertTypeB64, ...connectionTypesB64];\r\n        const certificates = await userWallet.listCertificates({\r\n            certifiers,\r\n            types: requestedTypesB64,\r\n            limit: Math.max(10, requestedTypesB64.length * 3),\r\n        });\r\n\r\n        const certificate = certificates.certificates.find((c: any) => c.type === profileCertTypeB64);\r\n\r\n        if (!certificate) {\r\n            addError('certificate', 'No certificate found');\r\n            const maybeErrors = Object.keys(errors).length > 0 ? errors : undefined;\r\n            return {\r\n                success: false,\r\n                data: null,\r\n                errors: maybeErrors,\r\n            };\r\n        }\r\n\r\n        // Decrypt certificate fields and verify them before signing\r\n        const decryptedFields = await MasterCertificate.decryptFields(\r\n            userWallet,\r\n            certificate.keyring,\r\n            certificate.fields,\r\n            certificate.certifier\r\n        );\r\n\r\n        // Now get the rest of the data from token\r\n        const token = await userWallet.listOutputs({\r\n            basket,\r\n            includeCustomInstructions: true,\r\n            limit: 1,\r\n        });\r\n\r\n        if (token.outputs.length === 0) {\r\n            addError('token', 'No token found');\r\n            const maybeErrors = Object.keys(errors).length > 0 ? errors : undefined;\r\n            return {\r\n                success: false,\r\n                data: null,\r\n                errors: maybeErrors,\r\n            };\r\n        }\r\n\r\n        const output = token.outputs[0];\r\n        let tokenData: any;\r\n        try {\r\n            tokenData = JSON.parse(output.customInstructions);\r\n        } catch {\r\n            addError('token', 'Invalid token customInstructions JSON');\r\n            const maybeErrors = Object.keys(errors).length > 0 ? errors : undefined;\r\n            return {\r\n                success: false,\r\n                data: null,\r\n                errors: maybeErrors,\r\n            };\r\n        }\r\n\r\n        // Fetch connections and check for verification certificates\r\n        const connections: ConnectionData[] = [];\r\n\r\n        for (let i = 0; i < connectionTypes.length; i++) {\r\n            const connType = connectionTypes[i];\r\n            try {\r\n                const connTypeB64 = connectionTypesB64[i];\r\n                const connCert = certificates.certificates.find((c: any) => c.type === connTypeB64);\r\n\r\n                if (connCert) {\r\n                    // Decrypt the connection URL from certificate\r\n                    const connFields = await MasterCertificate.decryptFields(\r\n                        userWallet,\r\n                        connCert.keyring,\r\n                        connCert.fields,\r\n                        connCert.certifier\r\n                    );\r\n\r\n                    if (connFields.url) {\r\n                        connections.push({\r\n                            type: extractConnectionTypeName(connType),\r\n                            url: connFields.url,\r\n                            verified: true,\r\n                        });\r\n                    }\r\n                }\r\n            } catch (error) {\r\n                addError(\r\n                    'connections',\r\n                    `Error checking ${connType} certificate${error instanceof Error && error.message ? `: ${error.message}` : ''}`\r\n                );\r\n            }\r\n        }\r\n\r\n        // Build actual response data\r\n        const profileData: ProfileData = {\r\n            displayName: decryptedFields.displayName,\r\n            description: tokenData.description || '',\r\n            locationLng: Number(decryptedFields.lng),\r\n            locationLat: Number(decryptedFields.lat),\r\n            email: decryptedFields.email,\r\n            phoneNumber: decryptedFields.phoneNumber,\r\n            imageKey: tokenData.imageKey || null,\r\n            privateFields: tokenData.privateFields || [],\r\n            websites: tokenData.websites || [],\r\n            connections,\r\n        };\r\n\r\n        const maybeErrors = Object.keys(errors).length > 0 ? errors : undefined;\r\n        return {\r\n            success: true,\r\n            data: profileData,\r\n            errors: maybeErrors,\r\n        };\r\n\r\n    } catch (error) {\r\n        addError('unknown', error instanceof Error ? error.message : 'Unknown error');\r\n        const maybeErrors = Object.keys(errors).length > 0 ? errors : undefined;\r\n        return {\r\n            success: false,\r\n            data: null,\r\n            errors: maybeErrors,\r\n        };\r\n    }\r\n}"],"mappings":"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","names":["maybeErrors"]}